// Prisma schema file
// https://pris.ly/d/prisma-schema

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/**
 * =======================
 * ENUMS
 * =======================
 */

enum TenantStatus {
  active
  suspended
  trial
}

enum SubscriptionPlan {
  free
  pro
  enterprise
}

enum Role {
  super_admin
  tenant_admin
  user
}

enum ProjectStatus {
  active
  archived
  completed
}

enum TaskStatus {
  todo
  in_progress
  completed
}

enum Priority {
  low
  medium
  high
}

/**
 * =======================
 * MODELS
 * =======================
 */

model Tenant {
  id               String           @id @default(uuid())
  name             String
  subdomain        String           @unique
  status           TenantStatus
  subscriptionPlan SubscriptionPlan
  maxUsers         Int
  maxProjects      Int
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt

  users    User[]
  projects Project[]
  tasks    Task[]
  audits   AuditLog[]

  @@map("Tenant")
}

model User {
  id           String   @id @default(uuid())
  tenantId     String?
  tenant       Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  email        String
  passwordHash String
  fullName     String
  role         Role
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  createdProjects Project[]  @relation("CreatedProjects")
  assignedTasks   Task[]     @relation("AssignedTasks")
  auditLogs       AuditLog[]

  @@unique([tenantId, email])
  @@map("User")
}

model Project {
  id          String        @id @default(uuid())
  tenantId    String
  tenant      Tenant        @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  name        String
  description String?
  status      ProjectStatus
  createdById String
  createdBy   User          @relation("CreatedProjects", fields: [createdById], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  tasks Task[]

  @@index([tenantId])
  @@map("Project")
}

model Task {
  id           String     @id @default(uuid())
  projectId    String
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)
  tenantId     String
  tenant       Tenant     @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  title        String
  description  String?
  status       TaskStatus @default(todo)
  priority     Priority   @default(medium)
  assignedToId String?
  assignedTo   User?      @relation("AssignedTasks", fields: [assignedToId], references: [id])
  dueDate      DateTime?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  @@index([tenantId, projectId])
  @@map("Task")
}

model AuditLog {
  id         String   @id @default(uuid())
  tenantId   String?
  tenant     Tenant?  @relation(fields: [tenantId], references: [id])
  userId     String?
  user       User?    @relation(fields: [userId], references: [id])
  action     String
  entityType String?
  entityId   String?
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@map("AuditLog")
}
